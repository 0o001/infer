<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.72">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Infer Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Infer Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Infer" href="/opensearch.xml"><title data-react-helmet="true">RacerD | Infer</title><meta data-react-helmet="true" property="og:url" content="https://fbinfer.com/docs/1.0.0/checker-racerd"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="1.0.0"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-1.0.0"><meta data-react-helmet="true" property="og:title" content="RacerD | Infer"><meta data-react-helmet="true" name="description" content="Thread safety analysis."><meta data-react-helmet="true" property="og:description" content="Thread safety analysis."><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://fbinfer.com/docs/1.0.0/checker-racerd"><link data-react-helmet="true" rel="alternate" href="https://fbinfer.com/docs/1.0.0/checker-racerd" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://fbinfer.com/docs/1.0.0/checker-racerd" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.46ed01ba.css">
<link rel="preload" href="/assets/js/styles.7a3bfc13.js" as="script">
<link rel="preload" href="/assets/js/runtime~main.f45cfbc3.js" as="script">
<link rel="preload" href="/assets/js/main.4397eb74.js" as="script">
<link rel="preload" href="/assets/js/1.b5bf5a34.js" as="script">
<link rel="preload" href="/assets/js/2.87dfd38b.js" as="script">
<link rel="preload" href="/assets/js/3.529b6fba.js" as="script">
<link rel="preload" href="/assets/js/1be78505.c4007472.js" as="script">
<link rel="preload" href="/assets/js/183.7a16840f.js" as="script">
<link rel="preload" href="/assets/js/62e81aa6.e2500d24.js" as="script">
<link rel="preload" href="/assets/js/17896441.1b2449d5.js" as="script">
<link rel="preload" href="/assets/js/15a3954c.1cd80389.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="Infer Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.png" alt="Infer Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Infer</strong></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/getting-started">Docs</a><a class="navbar__item navbar__link" href="/docs/support">Support</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a href="https://twitter.com/fbinfer" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Twitter</a><a href="https://www.facebook.com/inferstaticanalyzer" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Facebook</a><a href="https://github.com/facebook/infer" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_GrZ2"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="Infer Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.png" alt="Infer Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Infer</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/getting-started">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/support">Support</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://twitter.com/fbinfer" target="_blank" rel="noopener noreferrer" class="menu__link">Twitter</a></li><li class="menu__list-item"><a href="https://www.facebook.com/inferstaticanalyzer" target="_blank" rel="noopener noreferrer" class="menu__link">Facebook</a></li><li class="menu__list-item"><a href="https://github.com/facebook/infer" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper main-docs-wrapper"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Quick Start</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/1.0.0/getting-started">Getting started with Infer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/1.0.0/hello-world">Hello, World!</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">User Guide</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/1.0.0/infer-workflow">Infer workflow</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/1.0.0/analyzing-apps-or-projects">Analyzing apps or projects</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/1.0.0/steps-for-ci">Recommended flow for CI</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/1.0.0/advanced-features">Advanced usage</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Infer Manuals</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/1.0.0/man-infer">infer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/1.0.0/man-infer-analyze">infer analyze</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/1.0.0/man-infer-capture">infer capture</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/1.0.0/man-infer-compile">infer compile</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/1.0.0/man-infer-debug">infer debug</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/1.0.0/man-infer-explore">infer explore</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/1.0.0/man-infer-help">infer help</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/1.0.0/man-infer-report">infer report</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/1.0.0/man-infer-reportdiff">infer reportdiff</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/1.0.0/man-infer-run">infer run</a></li></ul></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Analyses and Issue Types</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0.0/all-issue-types">List of all issue types</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0.0/checker-annotation-reachability">Annotation Reachability</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0.0/checker-biabduction">Biabduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0.0/checker-bufferoverrun">Buffer Overrun Analysis (InferBO)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0.0/checker-config-checks-between-markers">Config Checks between Markers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0.0/checker-cost">Cost: Runtime Complexity Analysis</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0.0/checker-eradicate">Eradicate</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0.0/checker-fragment-retains-view">Fragment Retains View</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0.0/checker-immutable-cast">Immutable Cast</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0.0/checker-impurity">Impurity</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0.0/checker-inefficient-keyset-iterator">Inefficient keySet Iterator</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0.0/checker-linters">AST Language (AL)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0.0/checker-litho-required-props">Litho &quot;Required Props&quot;</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0.0/checker-liveness">Liveness</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0.0/checker-loop-hoisting">Loop Hoisting</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0.0/checker-printf-args">`printf()` Argument Types</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0.0/checker-pulse">Pulse</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0.0/checker-purity">Purity</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0.0/checker-quandary">Quandary</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/1.0.0/checker-racerd">RacerD</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0.0/checker-resource-leak-lab">Resource Leak Lab Exercise</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0.0/checker-siof">Static Initialization Order Fiasco</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0.0/checker-self-in-block">Self in Block</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0.0/checker-starvation">Starvation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0.0/checker-topl-biabd">TOPL</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0.0/checker-topl-pulse">TOPL</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0.0/checker-uninit">Uninitialized Value</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Foundations</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/1.0.0/about-Infer">About Infer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/1.0.0/separation-logic-and-bi-abduction">Separation logic and bi-abduction</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Contribute</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/1.0.0/absint-framework">Building checkers with the Infer.AI framework</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/1.0.0/internal-API">Infer Internal OCaml Modules API</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Versions</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/1.0.0/versions">Documentation Versions</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for Infer <strong>1.0.0</strong>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <strong><a href="/docs/checker-racerd">latest version</a></strong> (1.1.0).</div></div><div class="docItemContainer_33ec"><article><div><span class="badge badge--secondary">Version: 1.0.0</span></div><header><h1 class="docTitle_3a4h">RacerD</h1></header><div class="markdown"><p>Thread safety analysis.</p><p>Activate with <code>--racerd</code>.</p><p>Supported languages:</p><ul><li>C/C++/ObjC: Yes</li><li>Java: Yes</li></ul><p>RacerD finds data races in your C++ and Java code. This page gives a more in-depth
explanation of how the analysis works <em>for Java code</em>, but may be less complete than the
<a href="/docs/1.0.0/all-issue-types#thread_safety_violation">Thread Safety Violation bug description page</a>.</p><p>To run the analysis, you can use plain <code>infer</code> (to run RacerD along with other
analyses that are run by default) or <code>infer --racerd-only</code> (to run only RacerD).</p><p>For example, the command <code>infer --racerd-only -- javac File.java</code> will run
RacerD on File.java.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="background"></a>Background<a class="hash-link" href="#background" title="Direct link to heading">#</a></h2><p>RacerD statically analyzes Java code to detect potential concurrency bugs. This
analysis does not attempt to prove the absence of concurrency issues, rather, it
searches for a high-confidence class of data races. At the moment RacerD
concentrates on race conditions between methods in a class that is itself
intended to be thread safe. A race condition occurs when there are two
concurrent accesses to a class member variable that are not separated by mutual
exclusion, and at least one of the accesses is a write. Mutual exclusion can be
ensured by synchronization primitives such as locks, or by knowledge that both
accesses occur on the same thread.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="triggering-the-analysis"></a>Triggering the analysis<a class="hash-link" href="#triggering-the-analysis" title="Direct link to heading">#</a></h2><p>RacerD doesn&#x27;t try to check <em>all</em> code for concurrency issues; it only looks at
code that it believes can run in a concurrent context. There are two signals
that RacerD looks for: (1) Explicitly annotating a class/method with
<code>@ThreadSafe</code> and (2) using a lock via the <code>synchronized</code> keyword. In both
cases, RacerD will look for concurrency issues in the code containing the signal
and all of its dependencies. In particular, it will report races between any
non-<code>private</code> methods of the same class that can peform conflicting accesses.
Annotating a class/interface with <code>@ThreadSafe</code> also triggers checking for all
of the subclasses of the class/implementations of the interface.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="warnings"></a>Warnings<a class="hash-link" href="#warnings" title="Direct link to heading">#</a></h2><p>Let&#x27;s take a look at the different types of concurrency issues that RacerD
flags. Two of the warning types are data races (<code>Unprotected write</code> and
<code>Read/write race</code>), and the third warning type encourages adding <code>@ThreadSafe</code>
annotations to interfaces to trigger additional checking.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="unprotected-write"></a>Unprotected write<a class="hash-link" href="#unprotected-write" title="Direct link to heading">#</a></h3><p>RacerD will report an unprotected write when one or more writes can run in
parallel without synchronization. These come in two flavors: (1) a self-race (a
write-write race that occurs due to a method running in parallel with itself)
and (2) two conflicting writes to the same location. Here&#x27;s an example of the
self-race flavor:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@ThreadSafe</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class Dinner {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private int mTemperature;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  public void makeDinner() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    boilWater();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private void boilWater() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    mTemperature = 100; // unprotected write.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The class <code>Dinner</code> will generate the following report on the public method
<code>makeDinner()</code>:</p><p><code>There may be a Thread Safety Violation: makeDinner() indirectly writes to mTemperature outside of synchronization.</code></p><p>This warning can be fixed by synchronizing the access to <code>mTemperature</code>, making
<code>mTemperature</code> <code>volatile</code>, marking <code>makeDinner</code> as <code>@VisibleForTesting</code>, or
suppressing the warning by annotating the <code>Dinner</code> class or <code>makeDinner</code> method
with <code>@ThreadSafe(enableChecks = false)</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="readwrite-race"></a>Read/Write Race<a class="hash-link" href="#readwrite-race" title="Direct link to heading">#</a></h3><p>We sometimes need to protect read accesses as well as writes. Consider the
following class with unsynchronized methods.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@ThreadSafe</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class Account {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  int mBalance = 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  public void deposit(int amount) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (amount &gt; 0) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      mBalance += amount;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  public int withdraw(int amount){</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (amount &gt;= 0 &amp;&amp; mBalance - amount &gt;= 0) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      mBalance -= amount;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      return mBalance;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    } else {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      return 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>If you run the <code>withdraw()</code> method in parallel with itself or with <code>deposit()</code>
you can get unexpected results here. For instance, if the stored balance is 11
and you run <code>withdraw(10)</code> in parallel with itself you can get a negative
balance. Furthermore, if you synchronize only the write statement
<code>mBalance -= amount</code>, then you can still get this bad result. The reason is that
there is a read/write race between the boolean condition
<code>mBalance - amount &gt;= 0</code> and the writes. RacerD will duly warn</p><p><code>Read/Write race. Public method int Account.withdraw(int) reads from field Account.mBalance. Potentially races with writes in methods void Account.deposit(int), int Account.withdraw(int)</code></p><p>on the line with this boolean condition.</p><p>A solution to the threading problem here is to make both methods <code>synchronized</code>
to wrap both read and write accesses, or to use an <code>AtomicInteger</code> for
<code>mBalance</code> rather than an ordinary <code>int</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="interface-not-thread-safe"></a>Interface not thread-safe<a class="hash-link" href="#interface-not-thread-safe" title="Direct link to heading">#</a></h3><p>In the following code, RacerD will report an <code>Interface not thread-safe</code> warning
on the call to <code>i.bar()</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">interface I {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  void bar();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@ThreadSafe</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">class C {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  void foo(I i) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    i.bar(); // RacerD warns here</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The way to fix this warning is to add a <code>@ThreadSafe</code> annotation to the
interface <code>I</code>, which will enforce the thread-safety of each of the
implementations of <code>I</code>.</p><p>You might wonder why it&#x27;s necessary to annotate <code>I</code> -- can&#x27;t RacerD just look at
all the implementations of <code>i</code> at the call site for <code>bar</code>? Although this is a
fine idea idea in principle, it&#x27;s a bad idea in practice due to a (a) separate
compilation and (b) our diff-based deployment model. In the example above, the
compiler doesn&#x27;t have to know about all implementations (or indeed, any
implementations) of <code>I</code> at the time it compiles this code, so there&#x27;s no
guarantee that RacerD will know about or be able to check all implementations of
<code>I</code>. That&#x27;s (a). For (b), say that we check that all implementations of <code>I</code> are
thread-safe at the time this code is written, but we don&#x27;t add the annotation.
If someone else comes along and adds a new implementation of <code>I</code> that is not
thread-safe, RacerD will have no way of knowing that this will cause a potential
bug in <code>foo</code>. But if <code>I</code> is annotated, RacerD will enforce that all new
implementations of <code>I</code> are thread-safe, and <code>foo</code> will remain bug-free.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="annotations-to-help-racerd-understand-your-code"></a>Annotations to help RacerD understand your code<a class="hash-link" href="#annotations-to-help-racerd-understand-your-code" title="Direct link to heading">#</a></h2><p>Getting started with RacerD doesn&#x27;t require any annotations at all -- RacerD
will look at your usage of locks and figure out what data is not guarded
consistently. But increasing the coverage and signal-to-noise ratio may require
adding <code>@ThreadSafe</code> annotations along with some of the other annotations
described below. Most of annotations described below can be used via the Maven
Central package available
<a href="https://maven-repository.com/artifact/com.facebook.infer.annotation/infer-annotation" target="_blank" rel="noopener noreferrer">here</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="threadconfined"></a><code>@ThreadConfined</code><a class="hash-link" href="#threadconfined" title="Direct link to heading">#</a></h3><p>The intuitive idea of thread-safety is that a class is impervious to concurrency
issues for all concurrent contexts, even those that have not been written yet
(it is future-proof). RacerD implements this by naively assuming that any method
can potentially be called on any thread. You may determine, however, that an
object, method, or field is only ever accessed on a single thread during program
execution. Annotating such elements with <code>@ThreadConfined</code> informs RacerD of
this restriction. Note that a thread-confined method cannot race with itself but
it can still race with other methods.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">List mCache;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@ThreadConfined(UI)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">void prepareCache() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  // populate the cache</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  mCache.add(...);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  // post cache cleanup task to run later</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  mUIExecutor.execute(new Runnable() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @ThreadConfined(UI)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public void run() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      mCache.clear();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>In this example, both <code>prepareCache</code> and <code>run</code> touch <code>mCache</code>. But there&#x27;s no
possibility of a race between the two methods because both of them will run
sequentially on the UI thread. Adding a <code>@ThreadConfined(UI)</code> or <code>@UiThread</code>
annotation to these methods will stop it from warning that there is a race on
<code>mCache</code>. We could also choose to add a <code>@ThreadConfined</code> annotation to <code>mCache</code>
itself.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="functional"></a><code>@Functional</code><a class="hash-link" href="#functional" title="Direct link to heading">#</a></h3><p>Not all races are bugs; a race can be benign. Consider the following:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@Functional Boolean askNetworkIfShouldShowFeature();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">private Boolean mShouldShowFeature;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@ThreadSafe boolean shouldShowFeature() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if (mShouldShowFeature == null) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    mShouldShowFeature = askNetworkIfShouldShowFeature();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  return mShouldShowFeature;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>This code caches the result of an expensive network call that checks whether the
current user should be shown an experimental feature. This code looks racy, and
indeed it is: if two threads execute <code>shouldShowFeature()</code> at the same time, one
may read <code>mShouldShowFeature</code> at the same time the other is writing it.</p><p>However, this is actually a <em>benign</em> race that the programmer intentionally
allows for performance reasons. The reason this code is safe is that the
programmer knows that <code>askNetworkIfShouldShowFeature()</code> will always return the
same value in the same run of the app. Adding synchronization would remove the
race, but acquiring/releasing locks and lock contention would potentially slow
down every call to <code>shouldShowFeature()</code>. The benign race approach makes every
call after the first fast without changing the safety of the code.</p><p>RacerD will report a race on this code by default, but adding the
<code>@Functional annotation to askNetworkIfShouldShowFeature()</code> informs RacerD that
the function is always expected to return the same value. This assumption allows
RacerD to understand that this particular code is safe, though it will still
(correctly) warn if <code>mShouldShowFeature</code> is read/written elsewhere.</p><p>Be sure not to use the <code>@Functional</code> pattern for <em>singleton instantiation</em>, as
it&#x27;s possible the &quot;singleton&quot; can be constructed more than once.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class MySingleton {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  private static sInstance;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  // Not @Functional</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  public MySingleton getInstance() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (sInstance == null) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      // Different threads may construct their own instances.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      sInstance == new MySingleton();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return sInstance;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="returnsownership"></a><code>@ReturnsOwnership</code><a class="hash-link" href="#returnsownership" title="Direct link to heading">#</a></h3><p>RacerD does not warn on unprotected writes to <em>owned</em> objects. An object is
owned if it has been freshly allocated in the current thread and has not escaped
to another thread. RacerDf automatically tracks ownership in most cases, but it
needs help with <code>abstract</code> and <code>interface</code> methods that return ownership:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@ThreadSafe</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public interface Car {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  @ReturnsOwnership abstract Car buyCar();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  void carsStuff() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Car myCar = new Car();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    myCar.wheels = 4; // RacerD won&#x27;t warn here because it knows myCar is owned</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Car otherCar = buyCar();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    otherCar.wheels = 3; // RacerD would normally warn here, but won&#x27;t because of the `@ReturnsOwnership` annotation</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="visiblefortesting"></a><code>@VisibleForTesting</code><a class="hash-link" href="#visiblefortesting" title="Direct link to heading">#</a></h3><p>RacerD reports races between any two non<code>-private</code> methods of a class that may
run in a concurrent context. Sometimes, a RacerD report may be false because one
of the methods cannot actually be called from outside the current class. One fix
is making the method <code>private</code> to enforce this, but this might break unit tests
that need to call the method in order to test it. In this case, the
<code>@VisibleForTesting</code> annotation will allow RacerD to consider the method as
effectively <code>private</code> will still allowing it to be called from the unit test:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@VisibleForTesting void setF() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  this.f = ...; // RacerD would normally warn here, but @VisibleForTesting will silence the warning</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">synchronized void setFWithLock() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  setF();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Unlike the other annotations shown here, this one lives in
<a href="https://developer.android.com/reference/android/support/annotation/VisibleForTesting.html" target="_blank" rel="noopener noreferrer">Android</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="interprocedural-reasoning"></a>Interprocedural Reasoning<a class="hash-link" href="#interprocedural-reasoning" title="Direct link to heading">#</a></h2><p>An important feature of RacerD is that it finds races by analyzing not just one
file or class, but by looking at memory accesses that occur after going through
several procedure calls. It handles this even between classes and between files.</p><p>Here is a very basic example</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@ThreadSafe</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">class A{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  void m1(B bb) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    bb.meth_write();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">class B{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> Integer x;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> void meth_write() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   x = 88;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Class <code>B</code> is not annotated <code>@ThreadSafe</code> and does not have any locks, so RacerD
does not directly look for threading issues there. However, method <code>m1()</code> in
class <code>A</code> has a potential self-race, if it is run in parallel with itself and
the same argument for each call. RacerD discovers this.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">InterProc.java:17: error: THREAD_SAFETY_VIOLATION</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  Unprotected write. Non-private method `A.m1` indirectly writes to field `&amp;this.B.x` outside of synchronization.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> Reporting because the current class is annotated `@ThreadSafe`, so we assume that this method can run in</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> parallel with other non-private methods in the class (incuding itself).</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  15.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  16.     void m1(B bb) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  17. &gt;     bb.meth_write();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  18.     }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  19.   }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>RacerD does this sort of reasoning using what is known as a <em>compositional
inteprocedural analysis</em>. There, each method is analyzed independently of its
context to produce a summary of the behaviour of the procedure. In this case the
summaries for <code>m1()&#x27; and</code>meth()&#x27; include information as follows.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Procedure: void A.m1(B)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Accesses: { Unprotected({ 1 }) -&gt; { Write to &amp;bb.B.x at void B.meth_write() at line 17 } }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Procedure: void B.meth_write()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Accesses { Unprotected({ 0 }) -&gt; { Write to &amp;this.B.x at  at line 25 } }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The descriptions here are cryptic and do not include all the information in the
summaries, but the main point is that you can use RacerD to look for races in
codebases where the mutations done by threads might occur only after a chain of
procedure calls.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="context-and-selected-related-work"></a><a name="context"></a> Context and Selected Related Work<a class="hash-link" href="#context-and-selected-related-work" title="Direct link to heading">#</a></h2><p>Reasoning about concurrency divides into bug detection and proving absence of
bugs. RacerD is on the detection side of reasoning.</p><p>The rapid growth in the number of interleavings is problematic for tools that
attempt exhaustive exploration. With just 150 instructions for two threads, the
number 10^88 of interleavings is more that the estimated number of atoms in the
known universe.
<a href="https://en.wikipedia.org/wiki/Partial_order_reduction" target="_blank" rel="noopener noreferrer">There has been important work which uses various techniques to attempt to reduce the number of interleavings</a>
while still in principle covering all possibilities, but scale is still a
challenge. Note that RacerD is not exhaustive: it has false negatives (missed
bugs). But in compensation it is fast, and effective (it finds bugs in
practice).</p><p>Static analysis for concurrency has attracted a lot of attention from
researchers, but difficulties with scalability and precision have meant that
previous techniques have had little industrial impact. Automatic static race
detection itself has seen significant work. The most advanced approaches,
exemplified by the <a href="http://www.cis.upenn.edu/~mhnaik/pubs/pldi06.pdf" target="_blank" rel="noopener noreferrer">Chord</a>
tool, often use a whole-program analysis paired with a sophisticated alias
analysis, two features we have consciously avoided. Generally speaking, the
leading research tools can be more precise, but RacerD is faster and can operate
without the whole program: we have opted to go for speed in a way that enables
industrial deployment on a large, rapidly changing codebase, while trying to use
as simple techniques as possible to cover many (not all) of the patterns covered
by slower but precise research tools.</p><p>An industrial static analysis tool from
<a href="http://homepages.inf.ed.ac.uk/dts/pub/avocs2015.pdf" target="_blank" rel="noopener noreferrer">Contemplate</a> also targets
@ThreadSafe annotations, but limits the amount of inter-procedural reasoning:
“This analysis is interprocedural, but to keep the overall analysis scalable,
only calls to private and protected methods on the same class are followed”.
RacerD does deep, cross-file and cross-class inter-procedural reasoning, and yet
still scales; the inter-class capability was one of the first requests from
Facebook engineers.
<a href="https://code.facebook.com/posts/1537144479682247/finding-inter-procedural-bugs-at-scale-with-infer-static-analyzer/" target="_blank" rel="noopener noreferrer">A separate blog post looked at 100 recent data race fixes</a>
in Infer&#x27;s deployment in various bug categories, and for data races observed
that 53 of them were inter-file (and thus involving multiple classes).
<a href="#interprocedural-reasoning">See above</a> for an example of RacerD&#x27;s interprocedural
capabilities.</p><p>One reaction to the challenge of developing effective static race detectors has
been to ask the programmer to do more work to help the analyzer. Examples of
this approach include the
<a href="https://clang.llvm.org/docs/ThreadSafetyAnalysis.html" target="_blank" rel="noopener noreferrer">Clang Thread Safety Analyzer</a>,
the typing of <a href="https://doc.rust-lang.org/std/sync/struct.Mutex.html" target="_blank" rel="noopener noreferrer">locks</a> in
Rust, and the use/checking of @GuardedBy annotations in
<a href="https://homes.cs.washington.edu/~mernst/pubs/locking-semantics-nfm2016.pdf" target="_blank" rel="noopener noreferrer">Java</a>
including in
<a href="https://github.com/google/error-prone/blob/master/docs/bugpattern/GuardedBy.md" target="_blank" rel="noopener noreferrer">Google&#x27;s Error Prone analyzer</a>.
When lock annotations are present they make the analyzer&#x27;s life easier. It is possible to have a very effective race analysis without decreeing
that such annotations must be present. This was essential for our deployment,
since <em>requiring</em> lock annotations would have been a show stopper for converting
many thousands of lines of code to a concurrent context. We believe that this
finding should be transportable to new type systems and language designs, as
well as to other analyses for existing languages.</p><p>Another reaction to difficulties in static race detection has been to instead
develop dynamic analyses, automatic testing tools which work by running a
program to attempt to find flaws. Google&#x27;s Thread Sanitizer is a widely used and
mature tool in this area, which has been used in production to find many bugs in
C-family languages.
<a href="http://www.cs.columbia.edu/~junfeng/11fa-e6121/papers/thread-sanitizer.pdf" target="_blank" rel="noopener noreferrer">The Thread Sanitizer authors explicitly call out limitations with static race analyzers</a>
as part of their motivation: “It seems unlikely that static detectors will work
effectively in our environment: Google’s code is large and complex enough that
it would be expensive to add the annotations required by a typical static
detector”.</p><p>We have worked to limit the annotations that RacerD needs, for reasons similar
those expressed by the Thread Sanitizer authors. And we have sought to bring the
complementary benefits of static analysis — possibility of cheaper analysis and
fast reporting, and ability to analyze code before it is placed in a context to
run — to race detection. But we are interested as well in the future in
leveraging ideas in the dynamic techniques to improve or add to our analysis for
race detection.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="limitations"></a>Limitations<a class="hash-link" href="#limitations" title="Direct link to heading">#</a></h2><p>There are a number of known limitations to the design of the race detector.</p><ul><li>It looks for races involving syntactically identical access paths, and misses
races due to aliasing</li><li>It misses races that arise from a locally declared object escaping its scope</li><li>It uses a boolean locks abstraction, and so misses races where two accesses
are mistakenly protected by different locks</li><li>It assumes a deep ownership model, which misses races where local objects
refer to or contain non-owned objects.</li><li>It avoids reasoning about weak memory and Java&#x27;s volatile keyword</li></ul><p>Most of these limitations are consistent with the design goal of reducing false
positives, even if they lead to false negatives. They also allow technical
tradeoffs which are different than if we were to favour reduction of false
negatives over false positives.</p><p>A different kind of limitation concerns the bugs searched for: Data races are
the most basic form of concurrency error, but there are many types of
concurrency issues out there that RacerD does not check for (but might in the
future). Examples include deadlock, atomicity, and check-then-act bugs (shown
below). You must look for these bugs yourself!</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@ThreadSafe</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class SynchronizedList&lt;T&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  synchronized boolean isEmpty() { ... }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  synchronized T add(T item) { ... }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Not thread safe!!!</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class ListUtil&lt;T&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  public void addIfEmpty(SynchronizedList&lt;T&gt; list, T item) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (list.isEmpty()) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      // In a race, another thread can add to the list here.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      list.add(item);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Finally, using <code>synchronized</code> blindly as a means to fix every unprotected write
or read is not always safe. Even with RacerD, finding, understanding, and fixing
concurrency issues is difficult. If you would like to learn more about best
practices, <a href="http://jcip.net/" target="_blank" rel="noopener noreferrer">Java Concurrency in Practice</a> is an excellent
resource.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="list-of-issue-types"></a>List of Issue Types<a class="hash-link" href="#list-of-issue-types" title="Direct link to heading">#</a></h2><p>The following issue types are reported by this checker:</p><ul><li><a href="/docs/1.0.0/all-issue-types#guardedby_violation">GUARDEDBY_VIOLATION</a></li><li><a href="/docs/1.0.0/all-issue-types#interface_not_thread_safe">INTERFACE_NOT_THREAD_SAFE</a></li><li><a href="/docs/1.0.0/all-issue-types#lock_consistency_violation">LOCK_CONSISTENCY_VIOLATION</a></li><li><a href="/docs/1.0.0/all-issue-types#thread_safety_violation">THREAD_SAFETY_VIOLATION</a></li></ul></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/1.0.0/checker-quandary"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Quandary</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/1.0.0/checker-resource-leak-lab"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Resource Leak Lab Exercise »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#background" class="table-of-contents__link">Background</a></li><li><a href="#triggering-the-analysis" class="table-of-contents__link">Triggering the analysis</a></li><li><a href="#warnings" class="table-of-contents__link">Warnings</a><ul><li><a href="#unprotected-write" class="table-of-contents__link">Unprotected write</a></li><li><a href="#readwrite-race" class="table-of-contents__link">Read/Write Race</a></li><li><a href="#interface-not-thread-safe" class="table-of-contents__link">Interface not thread-safe</a></li></ul></li><li><a href="#annotations-to-help-racerd-understand-your-code" class="table-of-contents__link">Annotations to help RacerD understand your code</a><ul><li><a href="#threadconfined" class="table-of-contents__link"><code>@ThreadConfined</code></a></li><li><a href="#functional" class="table-of-contents__link"><code>@Functional</code></a></li><li><a href="#returnsownership" class="table-of-contents__link"><code>@ReturnsOwnership</code></a></li><li><a href="#visiblefortesting" class="table-of-contents__link"><code>@VisibleForTesting</code></a></li></ul></li><li><a href="#interprocedural-reasoning" class="table-of-contents__link">Interprocedural Reasoning</a></li><li><a href="#context-and-selected-related-work" class="table-of-contents__link"><a name="context"></a> Context and Selected Related Work</a></li><li><a href="#limitations" class="table-of-contents__link">Limitations</a></li><li><a href="#list-of-issue-types" class="table-of-contents__link">List of Issue Types</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started">Quick Start</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/infer-workflow">User Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/about-Infer">Foundations</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/all-issue-types">Bug Types Reference</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/absint-framework">Contribute</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/support">Support</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Social</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/infer" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://twitter.com/fbinfer" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://www.facebook.com/inferstaticanalyzer" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noreferrer noopener" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noreferrer noopener" class="footer__link-item">Terms</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 Facebook, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/styles.7a3bfc13.js"></script>
<script src="/assets/js/runtime~main.f45cfbc3.js"></script>
<script src="/assets/js/main.4397eb74.js"></script>
<script src="/assets/js/1.b5bf5a34.js"></script>
<script src="/assets/js/2.87dfd38b.js"></script>
<script src="/assets/js/3.529b6fba.js"></script>
<script src="/assets/js/1be78505.c4007472.js"></script>
<script src="/assets/js/183.7a16840f.js"></script>
<script src="/assets/js/62e81aa6.e2500d24.js"></script>
<script src="/assets/js/17896441.1b2449d5.js"></script>
<script src="/assets/js/15a3954c.1cd80389.js"></script>
</body>
</html>